{"version":3,"sources":["..\\..\\..\\..\\..\\assets\\script\\base/assets\\script\\base\\network.js"],"names":["base64","protobuf","util","PROTOCOL_PATH","for_maker","for_caller","socket","isConnect","isProtocolInited","protocolInfos","parseProtocol","filedata","cc","log","result","parse","packageName","package","objects","root","lookup","toJSON","Object","keys","nested","forEach","protocolName","protocol","map","fields","fieldName","push","startsWith","args","console","assert","length","fieldNames","data","i","argName","buffer","encode","finish","emit","initProtocols","files","filepath","loader","loadRes","err","exports","connect","url","sys","isNative","window","io","SocketIO","on","s_login_version","decodeArray","Uint8Array","decode","JSON","stringify","argValues","code","join","eval","isConnected"],"mappings":"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","file":"network.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\script\\base","sourcesContent":["var base64 = protobuf.util.base64;\r\n\r\nvar PROTOCOL_PATH = \"./protocol\";\r\n\r\n// 上行协议全局变量\r\nvar for_maker = {}\r\n// 下行协议全局变量\r\nvar for_caller = {}\r\n\r\n// window.for_maker = for_maker;\r\n// window.for_caller = for_caller;\r\n// require(\"binding\");\r\n\r\nvar socket = null;\r\nvar isConnect = false;\r\n\r\nvar isProtocolInited = false;\r\n\r\n// 配置只需要这4种数据类型\r\nvar protocolInfos = {};\r\n\r\n// 分析协议文件\r\nfunction parseProtocol(filedata) {\r\n    cc.log(\"parse filedata:\", filedata);\r\n    var result = protobuf.parse(filedata);\r\n    var packageName = result.package;\r\n    cc.log(\"parse package:\", packageName);\r\n\r\n    var objects = result.root.lookup(packageName).toJSON();\r\n    Object.keys(objects.nested).forEach(function (protocolName) {\r\n        var protocol = result.root.lookup(packageName + \".\" + protocolName);\r\n        cc.log(\" | protocol:\", protocolName);\r\n\r\n        var map = {\r\n            \"protocol\": protocol, // 协议数据\r\n            \"packageName\": packageName, // 协议package名\r\n            \"fieldNames\": [] // 协议参数列表\r\n        };\r\n        protocolInfos[protocolName] = map;\r\n\r\n        Object.keys(protocol.fields).forEach(function (fieldName) {\r\n            cc.log(\" |-- field:\", fieldName);\r\n            protocolInfos[protocolName][\"fieldNames\"].push(fieldName);\r\n        });\r\n\r\n        // 封装协议函数\r\n        if (protocolName.startsWith(\"s_\")) {\r\n            cc.log(\"init protocol:\", protocolName);\r\n            // 下行协议for_caller封装\r\n            for_caller[protocolName] = function (...args) {\r\n                // TODO 连接已断开的处理\r\n                if (!isConnect) {\r\n                    cc.log(\"> 连接已断开\");\r\n                    return;\r\n                }\r\n                console.assert(args.length == map.fieldNames.length);\r\n\r\n                // 创建协议参数数据结构\r\n                var data = {};\r\n                for (var i = 0; i < map.fieldNames.length; i++) {\r\n                    var argName = map.fieldNames[i];\r\n                    data[argName] = args[i];\r\n                }\r\n                // cc.log(\"> \" + protocolName + \": \" + JSON.stringify(data));\r\n\r\n                // Protobuf编码\r\n                var buffer = map.protocol.encode(data).finish();\r\n                // Base64编码之后发送出去\r\n                socket.emit(protocolName, base64.encode(buffer, 0, buffer.length));\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n// 初始化协议\r\nfunction initProtocols() {\r\n    // 先获取协议目录下的所有协议文件\r\n    var files = [\r\n        \"./protocol/login\",\r\n        \"./protocol/user\",\r\n        \"./protocol/racing\"\r\n    ];\r\n\r\n    // cc.log(files)\r\n    for (var i = 0, length = files.length; i < length; i++) {\r\n        // 文件相对路径\r\n        var filepath = files[i];\r\n        // 文件内容\r\n        cc.loader.loadRes(filepath, function (err, filedata) {\r\n            // 分析协议文件\r\n            parseProtocol(filedata);\r\n        });\r\n    }\r\n}\r\n\r\nexports.initProtocols = function () {\r\n    if (isProtocolInited) return;\r\n    isProtocolInited = true;\r\n    initProtocols();\r\n}\r\n\r\nexports.connect = function (url) {\r\n    if (cc.sys.isNative) {\r\n        window.io = SocketIO.connect;\r\n    } else {\r\n        // window.io = require('socket.io');\r\n    }\r\n\r\n    // 连接\r\n    cc.log(\"wsURL->\" + url)\r\n    socket = io(url);\r\n\r\n    socket.on('disconnect', function () {\r\n        isConnect = false;\r\n        cc.log(\"服务器已断开连接\");\r\n        // reconnect\r\n        // socket.open();\r\n    });\r\n    socket.on('connect', function () {\r\n        isConnect = true;\r\n        cc.log(\"服务器已连接\");\r\n        for_caller.s_login_version(1);\r\n    });\r\n\r\n    Object.keys(protocolInfos).forEach(function (protocolName) {\r\n        var map = protocolInfos[protocolName];\r\n        // 上行协议for_maker封装\r\n        if (protocolName.startsWith(\"c_\")) {\r\n            cc.log(\"init protocol:\", protocolName);\r\n            // 监听协议事件\r\n            socket.on(protocolName, function (data) {\r\n                // Base64解码\r\n                var decodeArray = new Uint8Array(base64.length(data));\r\n                base64.decode(data, decodeArray, 0);\r\n                // Protobuf解码\r\n                var data = map.protocol.decode(decodeArray);\r\n\r\n                cc.log(\"> \" + protocolName + \": \" + JSON.stringify(data));\r\n                // 查找for_maker函数\r\n                if (for_maker[protocolName]) {\r\n                    var argValues = [];\r\n                    for (var i = 0; i < map.fieldNames.length; i++) {\r\n                        var argName = map.fieldNames[i];\r\n                        argValues.push(\"data.\" + argName);\r\n                    }\r\n                    var code = \"for_maker[protocolName](\" + argValues.join(\", \") + \");\";\r\n                    eval(code);\r\n                }\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\nexports.isConnected = function () {\r\n    return isConnect;\r\n}\r\n\r\n"]}